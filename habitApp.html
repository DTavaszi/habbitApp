<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>HabitApp</title>
 
        <link href="css/style.css" rel="stylesheet">
		<link href="css/bootstrap.css" rel="stylesheet">
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css"/>
	<style type="text/css">
	</style>
	</head>
    <body>
	
<pre id="debug"> </pre>
		<div class="container">
			<div  class="hero-unit">
				<button id="addHabits">Add habit</button>	
				<button id="redrawHabits">Redraw habits</button>				
			</div>
			
		</div>
		<div id="buttonField" class="button-field"></div>

		<div id="Schedule"/>

		<!--This is the dialog for creating habits-->
		<div id="dialog-form" title="Form a habit">
		  <p class="validateTips">All form fields are required.</p>		  
		  <form>
		  <fieldset>
			<label for="habit">Name your habit:</label>
			<input type="text" name="habit" id="habit" class="text ui-widget-content ui-corner-all" />
			<label for="target"></label>
			<label for="target">Target goal:</label>
			<input type="text" name="target" id="target" class="text ui-widget-content ui-corner-all" />	
			<br/>
			
			<select id="selectDay">
			  <option value="0">Monday</option>
			  <option value="1">Tuesday</option>
			  <option value="2">Wednesday</option>
			  <option value="3">Thursday</option>
			  <option value="4">Friday</option>
			  <option value="5">Saturday</option>
			  <option value="6">Sunday</option>
			</select>	
			
			<input type="checkbox" name="chkWeek" id="chkWeek"> Per Week
			<input type="checkbox" name="chkDay" id="chkDay"> Per day
			
		  </fieldset>
		  </form>
		</div>
    </body>	
	
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
	<script type="text/javascript">		
		
		//Separate counter value from habit. Need a new habit list for each unique habit instance.
		
		//DNDHTML5
		var dragSrcEl = null;
		function handleDragOver(e) {
		  if (e.preventDefault) {
			e.preventDefault(); // Necessary. Allows us to drop.
		  }

		  e.dataTransfer.dropEffect = 'move';  // See the section on the DataTransfer object.

		  return false;
		}

		function handleDragEnter(e) {
		  // this / e.target is the current hover target.
			this.classList.add('over');
		}

		function handleDragLeave(e) {
		  this.classList.remove('over');  // this / e.target is previous target element.
		}

		function handleDragEnd(e) {
		  // this/e.target is the source node.
			this.style.opacity = "1.0";
		  [].forEach.call(cols, function (col) {
			col.classList.remove('over');
		  });
		}


		var dragSrcEl = null;
		var dropSrcEl = null;

		function handleDragStart(e) {
		  // Target (this) element is the source node.
		  this.style.opacity = '0.4';

		  dragSrcEl = this;

		  e.dataTransfer.effectAllowed = 'move';
		  e.dataTransfer.setData('text/html', this.innerHTML);
		}

		function handleDrop(e) {
		  // this/e.target is current target element.

		  if (e.stopPropagation) {
			e.stopPropagation(); // Stops some browsers from redirecting.
		  }

		  // Don't do anything if dropping the same column we're dragging.
		  if (dragSrcEl != this) {
			// Set the source column's HTML to the HTML of the column we dropped on.
			
			//alert(this.innerHTML);
			this.innerHTML += "<div class='drag'>" + dragSrcEl.innerHTML + "</div>";
			//dragSrcEl.innerHTML = null;
			dragSrcEl = null;
		  }
		  return false;
		}
		
		//{name : habit.val(), counter : 0, target : target.val(), perWeek : pWeek }
		//{name, target, pDayWeek, currTarget, daysOfWeek, progress}		

//DNDHTML5
		function createInstance(habit, habitDay, habitInstances)
		{
			
		}
		
		function createHabit(habit, day, habitNumber, habitInstances)
		{			
			var bfield = 'bfield' + habitNumber;
			$('#' + day).append($('<div id=' + bfield + ' class="drag" draggable="true">'));
			
			var habitButton = document.createElement("label");
			//habitButton.type = "label";
			habitButton.style.textAlign="left";
			habitButton.innerHTML = habit.name;
			habitButton.style.width="100px";			
			document.getElementById(bfield).appendChild(habitButton);
			
			var plusButton = document.createElement("input");
			plusButton.type = "button";
			plusButton.value = "+";	
			plusButton.onclick = function () 
											{ 									
												return (function (button)
													{
														if(habit.currTarget < habit.target)
														{
															habit.currTarget++;
															button.value = habit.currTarget;
														}											
													})(counterButton)							
											};										
			
			document.getElementById(bfield).appendChild(plusButton);
			$('#' + bfield).append($('<br/>'));
			
			//CounterButton
			var counterButton = document.createElement("input");
			counterButton.type = "button";
			counterButton.style.textAlign="center";
			counterButton.style.width="100px";			
			counterButton.style.border= "2px inset #cccccc";
			document.getElementById(bfield).appendChild(counterButton);
			$('#' + bfield).append($('<p/>'));
			
			//Add drag listeners
			var hab = document.getElementById(bfield);			  
			hab.addEventListener('dragstart', handleDragStart, false);
			hab.addEventListener('dragenter', handleDragEnter, false);
			hab.addEventListener('dragover', handleDragOver, false);
			hab.addEventListener('dragleave', handleDragLeave, false);
			hab.addEventListener('drop', handleDrop, false);
			hab.addEventListener('dragend', handleDragEnd, false);			
		}
		
		function createHabits(myHabits, habitInstances)		
		{
			var days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
			
					
			var element = document.getElementById("Schedule");
			while (element.firstChild) {
			  element.removeChild(element.firstChild);				  
			} 	
			
			
			drawWeek(0);
			for (var i = 0; i < myHabits.length; i++)
			{
				createHabit(myHabits[i], myHabits[i].daysOfWeek, i+1, habitInstances);																			
			}			
		}
		
		//Check if a date object is today
		function isToday(date)
		{
			var todate = new Date();
			
			if (date.getDate() == todate.getDate() && date.getMonth() == todate.getMonth() && date.getYear() == todate.getYear())
				return true;
			else
				return false;
		}
		//Define Weekly view (Sun->Sat)	
		function drawWeek(currentWeek)
		{
			var days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
			var weekList = getWeek(currentWeek);
			
			for(var i=0; i<7; i++)
			{
				if(isToday(weekList[i]))
				{
					$('#Schedule').append($('<div id=' + days[i] + ' class="day today"><header>' + days[i] + '<br/>' + weekList[i].getDate() + '/' + (weekList[i].getMonth()+1) + '</header></div>'));
				}
				else {
					$('#Schedule').append($('<div id=' + days[i] + ' class="day"><header>' + days[i] + '<br/>' + weekList[i].getDate() + '/' + (weekList[i].getMonth()+1) + '</header></div>'));					
				}
			}
			
			var days = document.querySelectorAll('.day');
			[].forEach.call(days, function(day) {
			  day.addEventListener('dragenter', handleDragEnter, false);
			  day.addEventListener('dragover', handleDragOver, false);
			  day.addEventListener('dragleave', handleDragLeave, false);
			  day.addEventListener('drop', handleDrop, false);
			  day.addEventListener('dragend', handleDragEnd, false);
			});		
		}
		window.onload = function(){
			var myHabits = [];	
			//{name, target, pDayWeek, daysOfWeek, progress}
			var habitInstances = [];
			//{name, dayOfWeek, currTarget}
			
			//daysOfWeek = [day, time]
			//progress = [currTarget, target] //up to 60 cases?
			
			//Week definition
			//currentWeek defines which week we are on. 0 represents present week, 1+ future and 1- past (used for scrolling)
			var currentWeek = 0;
				
				drawWeek(currentWeek);
				
			//Define form
			document.getElementById('addHabits').onclick = function () { return $( "#dialog-form" ).dialog( "open" ) };
			
			document.getElementById('redrawHabits').onclick = function () { return createHabits(myHabits, habitInstances) };
			var habit = $( "#habit" ), //Variables for the Create Habit dialog
			  target = $( "#target" ),			  
			  allFields = $( [] ).add( habit ).add( target ),
			  day = document.getElementById("selectDay"),
			  tips = $( ".validateTips" );
			document.getElementById("chkWeek").checked = true;  
			document.getElementById("chkDay").onclick = function () { 
																		document.getElementById("chkWeek").checked = false;
																		};
			document.getElementById("chkWeek").onclick = function () { 
																		document.getElementById("chkDay").checked = false;
																		};
																		
			$( "#dialog-form" ).dialog({
			  autoOpen: false,
			  height: 400,
			  width: 350,
			  modal: true,
			  buttons: {
				"Create an account": function() {
				
				  var bValid = true;
				  
				  allFields.removeClass( "ui-state-error" );
				  bValid = bValid && checkLength( habit, "habit", 3, 16 );
				  bValid = bValid && checkLength( target, "target", 1, 2 );
				  
				  bValid = bValid && checkRegexp( habit, /^[a-z]([0-9a-z_])+$/i, "Habit may consist of a-z, 0-9, underscores, begin with a letter." );
				  if ( bValid ) {
					var pWeek = document.getElementById("chkWeek").checked;

					/*myHabits.push({name : habit.val(), currTarget : 0, target : target.val(), pDayWeek : pWeek, daysOfWeek : {Monday : 0,
																															 Tuesday : 0,
																															Wednesday : 0,
																															Thursday : 0,
																															Friday : 0,
																															Saturday : 0,
																															Sunday : 0},	*/
					
					myHabits.push({name : habit.val(), currTarget : 0, target : target.val(), pDayWeek : pWeek, daysOfWeek : getDayValue(parseInt(day.value)), progress : void(0)});
					
					createHabit(myHabits[myHabits.length-1], myHabits[myHabits.length-1].daysOfWeek, myHabits.length);
					$( this ).dialog( "close" );
				  }
				},
				Cancel: function() {
				  $( this ).dialog( "close" );					
				}
			  },
			  close: function() {
				allFields.val( "" ).removeClass( "ui-state-error" );
			  }
			});	
			
				
		}			

	
	function getWeek(numWeeks)
	{		
		var list = [];
		var date = new Date();
		
		var numDays = (numWeeks * 7) + date.getDate() - date.getDay(); //It will be the Monday numWeeks in advance of the current date
		
		for (var i = 0; i < 7; i++)
		{				
			var newDate = new Date();
			newDate.setDate(numDays + i);
			list[i] = newDate;
		}		
		
		return list;
	}	

	function getDayValue (selectedDay) {
		/*switch (selectedDay)
		{
			case 0:	return {Monday : 1, Tuesday : 0, Wednesday : 0, Thursday : 0, Friday : 0, Saturday : 0, Sunday : 0};
			case 1: return {Monday : 0, Tuesday : 1, Wednesday : 0, Thursday : 0, Friday : 0, Saturday : 0, Sunday : 0};
			case 2: return {Monday : 0, Tuesday : 0, Wednesday : 1, Thursday : 0, Friday : 0, Saturday : 0, Sunday : 0};
			case 3: return {Monday : 0, Tuesday : 0, Wednesday : 0, Thursday : 1, Friday : 0, Saturday : 0, Sunday : 0};
			case 4: return {Monday : 0, Tuesday : 0, Wednesday : 0, Thursday : 0, Friday : 1, Saturday : 0, Sunday : 0};
			case 5: return {Monday : 0, Tuesday : 0, Wednesday : 0, Thursday : 0, Friday : 0, Saturday : 1, Sunday : 0};
			case 6: return {Monday : 0, Tuesday : 0, Wednesday : 0, Thursday : 0, Friday : 0, Saturday : 0, Sunday : 1};
			}*/
		switch (selectedDay)
		{
			case 0:	return "Monday";
			case 1: return "Tuesday";
			case 2: return "Wednesday";
			case 3: return "Thursday";
			case 4: return "Friday";
			case 5: return "Saturday";
			case 6: return "Sunday";
		}										
	}
	
    function updateTips( t ) {
      tips
        .text( t )
        .addClass( "ui-state-highlight" );
      setTimeout(function() {
        tips.removeClass( "ui-state-highlight", 1500 );
      }, 500 );
    } 
	
    function checkLength( o, n, min, max ) {
      if ( o.val().length > max || o.val().length < min ) {
        o.addClass( "ui-state-error" );
        updateTips( "Length of " + n + " must be between " +
          min + " and " + max + "." );
        return false;
      } else {
        return true;
      }
    } 
	
    function checkRegexp( o, regexp, n ) {
      if ( !( regexp.test( o.val() ) ) ) {
        o.addClass( "ui-state-error" );
        updateTips( n );
        return false;
      } else {
        return true;
      }
    } 
</script>
</html>